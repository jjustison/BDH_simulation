---
title: "Expectation Conundrum"
author: "Josh Justison"
date: "12/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background

I am simulating the number of lineages under a birth-death-hybridization process and my simulation results don't seem to be aligning with the expected values that I computed.

### The Birth-Death-Hybridization Process

For the purposes of this document, I am only concerned with the number of lineages, $N$, in the process, so no phylogenetic topology involved. This process considers speciation, extinction, lineage generative hybridization, and lineage degenerative hybridization. We are ignoring lineage neutral hybridization as it doesn't affect the number of lineages. Each of these events are a poisson process governed by the rates $\lambda, \mu, \nu_{+}$, and $\nu_{-}$, respectively. Speciation and extinction rates are per lineage rates, meaning that the overall rate of these events grow linearly with the number of lineages. On the other hand, the hybridization events are per lineage pair rates, meaning that they grow combinatorically with the number of lineages. Speciation and lineage generative hybridization add a lineage while extinction and lineage degenerative hybridization remove a lineage.


All in all the process looks something like this:

| Event       | Parameter           | Overall Rate  | Change in lineages | 
| :-----------: |:----------:| :-----:|:----:|
| Speciation      | $\lambda$ | $N\lambda$ | $N \rightarrow N+1$ |
| Extinction    | $\mu$      |   $N\mu$ | $N \rightarrow N-1$ |
| Lineage Generative Hybridization |  $\nu_{+}$     |  ${N\choose{2}}\nu_{+}$  | $N \rightarrow N+1$ |
| Lineage Degenerative Hybridization |  $\nu_{-}$     |  ${N\choose{2}}\nu_{-}$  | $N \rightarrow N-1$ |

So the overall rate that we add a lineage to the process is $N\lambda + {N\choose{2}}\nu_{+}$ while the overall rate that we lose a lineage is $N\mu + {N\choose{2}}\nu_{-}$

### Expected Number of Lineages of the Process

Now let's consider the expected number of lineages from this process $N(t)$ at a given time $t$.

We can derive a formula for our expectation by first considering how this expectation changes after some small time $\Delta{t}$:

$$
N(t+\Delta{t}) = N(t)\lambda\Delta{t} - N(t)\mu\Delta{t} + {N(t)\choose{2}}\nu_{+}\Delta{t} - {N(t)\choose{2}}\nu_{-}\Delta{t}
$$

Now we can take $\lim_{\Delta{t} \rightarrow0}$ and divide by $dt$ to get:

$$
{dN\over{dt}} =  N\lambda - N\mu + {N\choose{2}}\nu_{+} - {N\choose{2}}\nu_{-}
$$
$$
{dN\over{dt}} =  N\lambda - N\mu + {N(N-1)\over{2}}\nu_{+} - {N(N-1)\over{2}}\nu_{-}
$$
$$
{dN\over{dt}} =  N{(\lambda -\mu)} + {N(N-1)\over{2}}(\nu_{+} - \nu_{-})
$$
Now let $r = \lambda-\mu$ and $s={1\over2}(\nu_+-\nu_-)$. I think of these as the diversification and hybrid diversficiation rates, respectively.
$$
{dN\over{dt}} =  Nr + N(N-1)s
$$
$$
{dN\over{dt}} =  Nr + N^2s - Ns
$$
$$
{dN\over{dt}} =  N(r-s) + N^2s 
$$
Now we can separate the $N's$ and $t's$ onto different sides of the equation and integrate to solve but also note that we can put this equation into the same form of the logisitic equation with a known solution:
$$
{dN\over{dt}} =  N(r-s)(1 - {{-sN}\over{r-s}}) 
$$
Now let $k=r-s$ and $K={{r-s}\over-s}$ to get the logistic equation:
$$
{dN\over{dt}} =  kN(1-{N\over{K}})
$$
We will use the starting condition $N(0)=N_0$ to get the known solution to the logistic differential equation:

$$
N(t) = {K\over{1+{{K-N_0}\over{N_0}}}e^{-kt}}
$$
Plugging in our values for $K$ and $k$ we get:
$$
N(t) = {{{{r-s}\over-s}}\over{1+{{{{{r-s}\over-s}}-N_0}\over{N_0}}}e^{-(r-s)t}}
$$
$$
N(t) = {{{{1\over-s}(r-s})}\over{{1\over-s}({{{{r-s}}+sN_0}\over{N_0}}}e^{-(r-s)t}-s)}
$$
$$
N(t) = {{{(r-s})}\over{{{N_0s+r-s}\over{N_0}}}e^{-(r-s)t}-s}
$$
Integrating and solving the differential equation would result in the same solution as using the logistic equation trick but saves a lot of hassle.


### R Implementation of the Expected Number of Lineages
I created a function in `R` for this expectation.  
```{r}
expected_N<-function(age,lambda,mu,nu_pos,nu_neg,N0=2){
  
  r<-lambda-mu
  s<-0.5*(nu_pos-nu_neg)
  
  top<-r-s
  first<- (N0*s+top)/N0
  second<-exp(-(top)*age)
  
  return(top/((first*second)-s))
}
```

**Note:** We may get negative values from our equation when $s>0$ and $t$ is sufficiently large because in this case the expectation can actually climb to infinity in a finite time because we have hyperexponential growth. For simplicity sake, going forward we will assume $s<0$ but the issues that appear will also be true for all values of $s$.

### Simulating the Birth-Death-Hybridization Process
I wrote a function that simulates the number of lineages under the birth-death-hybridization process.

```{r}
sim_N<-function(age,lambda,mu,nu_pos,nu_neg,N0=2){
  time<-0
  n<-N0
  
  while(n!=0){ #Continue while there are still living lineages
    birth<- (n*lambda) + (choose(n,2)*nu_pos) ##speciation plus lineage generative hybridization
    death<- (n*mu)     + (choose(n,2)*nu_neg) ##extinction plus lineage degenerative hybridization
    total_rate<-birth+death
    
    time_step<-rexp(1,rate=total_rate) ##The waiting time until the next event
    time<-time+time_step
    if(time>age){ ##If the next event happens after our specified age we leave the loop
      break
    }
    randevent<-runif(1) 
    if(randevent < (birth/total_rate)){ ##Determine whether we gain or lose a lineage
      n<- n+1
    }else{
      n<- n-1
    }
  }
  return(n)
}
```


## The Conundrum

The idea here is that if I run `sim_N()` a bunch of times and take the mean then, assuming I ran enough simulations, it should tend towards the value given by `expected_N()`. However, this doesn't appear to be the case:

```{r}

#parameters
age<-1
lambda<-5
mu<-2
nu_pos<-0.10
nu_neg<-0.25
N0<-2

nsims<-100000
nlineages<-rep(NA,nsims)
for(i in 1:nsims){
  nlineages[i]<-sim_N(age=age,lambda=lambda,mu=mu,nu_pos=nu_pos,nu_neg=nu_neg,N0=N0)
}

mean(nlineages)
expected_N(age=age,lambda=lambda,mu=mu,nu_pos=nu_pos,nu_neg=nu_neg,N0=N0)
```

Oof, the simulated mean is quite a bit lower than the expected value, especially for $100,000$ simulations. From other simulations it appears that for $s<0$, our expectation from simulation is consistently lower than the analytic expectation. Conversely, when $s>0$ our simulation expectation is higher than the analytic expectation. My interpretation of this is that during simulation the hybridization dynamics somehow control more of the change in number of lineages than they should. 

**NOTE:** When $s=0$ then our simulation actually matches the analytic solution. Regardless of whether the hybridization rates are both zero or just the hybrid diversification rate is zero.

I am not sure whether the analytic expectation or my simulations are incorrect. So somewhere I must be representing the process incorrectly but both forms seem reasonable to me. I may be staring too closely at the problem, does anybody see a difference between these representations of the birth-death-hybridization process?

## Extra Credit Conundrum

In both forms of modeling the process I would expect that the expected number lineages to rely on hybridization only in $s$; that is, I would expect $(\nu_+=0.15, \nu_-=0.25)$ and $(\nu_+=0,\nu_-=0.1)$ to both have the same expected diversification dynamics since $s=0.05={1\over{2}}(0.15-0.25)={1\over{2}}(0-0.10)$. However we don't exactly see the same value when we simulate under these different conditions.

Here I will run different simulations where I keep $s$ the same but change the magnitudes of $\nu_+$ and $\nu_-$.

```{r}


nu<-seq(0.15,0.50,by=0.05) ##These are the different nu_pos + nu_neg = nu values we'll be using
ave_lineages<-rep(NA,length(nu))
var_lineages<-rep(NA,length(nu))
diff<- -0.15
nu_pos<- (diff+nu)/2
nu_neg<- nu-nu_pos

vals<-as.data.frame(cbind(nu,nu_pos,nu_neg,ave_lineages,var_lineages))
for(i in 1:length(nu)){
  age<-1
  lambda<-5
  mu<-2
  nu_pos<-vals$nu_pos[i]
  nu_neg<- vals$nu_neg[i]
  N0<-2

  nreps<-100000
  nlineages<-rep(NA,nreps)
  for(j in 1:nreps){
    nlineages[j]<-sim_N(age=age,lambda=lambda,mu=mu,nu_pos=nu_pos,nu_neg=nu_neg,N0=N0)
  }

  vals$ave_lineages[i]<-mean(nlineages)
  vals$var_lineages[i]<- var(nlineages)
}
print(vals)
```

Here we can see that `ave_lineages` consistently decreases when we increase the values of $\nu_+$ and $\nu_-$ but keep $s$ the same. The change in `ave_lineages` is relatively small but much more patterned than I would think that would happen by chance. If the average number of lineages only depending on the difference between $\nu_+$ and $\nu_-$ then I would expect values to jump up and down as opposed to decreasing. Perhaps this trend is due to the increased variation of the number of lineages in each scenario and that we are just getting poorer estimates of the mean as a result. However, with $100,000$ simulations I am not sure that is the most plausible explaination.
