---
title: "Untitled"
author: "Josh Justison"
date: "12/14/2021"
output: html_document
---

```{r setup, include=FALSE}

```

## Simulating Phylogenetic Networks



### Does the type of hybridiztion matter?

The different types of hybridization certainly can have different affects on the diversification process by either adding, eliminating, or not changing the number of lineages at each event.

Here we simulate phylogenetic networks using constant parameters $age=1$, $\lambda=4$, $\mu=2$, $\nu=0.2$, and having the process start with two lineages. Then I have three different hybridization diversification rates $s =\nu_+-\nu_- = (-0.1,0.0,0.1)$*. Given each of these diversification settings and a constant $nu$, we can change the proportions of each type of hybridization. For example, for the hybridization rates $(\nu_+,\nu_-,\nu_0,)$, both $(0.1,0.0,0.2)$ and $(0.2,0.1,0.0)$ both represent very different hybridization type rates but have the same expected number of species $s=0.1$. For each diversification scenario, we will vary $\nu_0$ from $0.0$ to its max allowable value for the given $nu$.

*The expected diversification dynamics can change quite dramatically depending on the hybrid diversification rate. For example, when $s$ is positive then the expected number of extant lineages will often increase quickly and approach infinity in a finite amount of time while the expected number of lineages approaches a constant value when $s$ is negative.

Here we can look at how, when keeping expected diversification dynamics the same, the landscape (in particular the class membership) of networks changes. We will also evaluate how these differences manifest between the complete and reconstructed phylogeny

###

```{r}

library(Ternary)
library(tidyr)
library(dplyr)
path<-'../data'



nu_func<-function() 0.2
divs<- c(-0.1,0,0.1) ##this is hybridization diversification

my_frame<-as.data.frame(matrix(NA,nrow = 20000*11*3,ncol=9))
colnames(my_frame)<- c('rets'	,'tips','level','tree_child','tree_based','fu_stable','recon','nu_neut','s')
frame2<-as.data.frame(matrix(NA,nrow = 10000*11*3,ncol=4))
colnames(frame2)<-c('rets','tips','nu_neut','s')
count<-0
n1<-rep(NA,11*3)
n2<-rep(NA,11*3)
n3<-rep(NA,11*3)
for(s in divs){
  file_name_base<-paste(path,'/s_',as.double(s),'_nu_neut',sep='')
  props<-seq(0,nu_func()-abs(s),length.out=11)
  
  
  for(nu_neutral in props){
    file_name<-paste(file_name_base,'/nu_neut_',nu_neutral,'/phydata.csv',sep = '')
    nu_pos <- (nu_func()-nu_neutral+s)/2
    nu_neg <- nu_pos-s
    
    n1[count+1]<-nu_pos
    n2[count+1]<-nu_neg
    n3[count+1]<-nu_neutral
    
    
    
    dat <- read.csv(file =file_name)[,-1]
    nrows<-nrow(dat)
    frame2$rets[((count*nrows)+1):((count+1)*nrows)]<-dat$rec_rets/dat$rets
    frame2$tips[((count*nrows)+1):((count+1)*nrows)]<-dat$rec_tips/dat$tips
    frame2$s[((count*nrows)+1):((count+1)*nrows)] <-s
    frame2$nu_neut[((count*nrows)+1):((count+1)*nrows)]<-nu_neutral

    to_bind<-dat[,7:12]
    dat<-dat[,-(7:12)]
    colnames(to_bind)<-colnames(dat)
    recon<-c(rep(F,nrows),rep(T,nrows))
    dat<-rbind(dat,to_bind)
    ss<-rep(s,2*nrows)
    nu_neut<-rep(nu_neutral,2*nrows)
    dat<-cbind(dat,recon,nu_neut,ss)
    
    my_frame[((count*2*nrows)+1):((count+1)*2*nrows),]<-dat
    count<-count+1
  }
}

my_frame$rets[is.nan(my_frame$rets)]<-0
my_frame<-as_tibble(my_frame)

summed<- my_frame %>% 
  group_by(s,nu_neut,recon) %>%
  summarize(tc = sum(tree_child)/n(),
            tb = sum(tree_based)/n(),
            fus= sum(fu_stable)/n(),
            ratio = mean(rets/tips),
            tips = mean(tips))
grouped <- summed %>%
  group_by(s,recon)

grouped
library(ggplot2)

ggplot(grouped,aes(nu_neut,tc,color =as.factor(s),linetype=recon)) + geom_line()
ggplot(grouped,aes(nu_neut,tb,color =as.factor(s),linetype=recon)) + geom_line()
ggplot(grouped,aes(nu_neut,fus,color =as.factor(s),linetype=recon)) + geom_line()
ggplot(grouped,aes(nu_neut,ratio,color =as.factor(s),linetype=recon)) + geom_line()
ggplot(grouped,aes(nu_neut,tips,color =as.factor(s),linetype=recon)) + geom_line()
frame2$rets[is.nan(frame2$rets)]<-0
group2 <-frame2 %>%
  group_by(s,nu_neut) %>%
  summarize(ret_per= mean(rets),
            tips_per = mean(tips))
group2
ggplot(group2,aes(nu_neut,ret_per,color=as.factor(s)))+geom_line()
ggplot(group2,aes(nu_neut,tips_per,color=as.factor(s)))+geom_line()


ave_N<-function(age,lambda,mu,nu_pos,nu_neg,N0=2){
  r<-lambda-mu
  s<-0.5*(nu_pos-nu_neg)

  val<- (-log(abs(s*(N0*(exp((r-s)*age)-1)+1)-r)))/s
  val2<-(-log(abs(s*(N0*(exp((r-s)*0)-1)+1)-r)))/s
  return(val-val2)
}


N1<-ave_N(1,4,2,0.05,0.15)
N2<-ave_N(1,4,2,0.15,0.05)
N1
N2
((N1*(N1-1))/2)*0.15
((N2*(N2-1))/2)*0.05

((N1*(N1-1))/2)*0.2
((N2*(N2-1))/2)*0.2


TernaryPlot(atip = expression(nu['+']),
            btip = expression(nu['-']),
            ctip = expression(nu['0']),axis.labels = seq(0,1,by=0.1),axis.cex=0.5
)

dat <- data.frame(n1,
                 n2,
                 n3)
TernaryPoints(dat)

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
